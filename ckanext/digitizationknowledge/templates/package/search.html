{% ckan_extends %}

{% block breadcrumb_content %}
  <li class="active">
    {% if dataset_type == 'dataset' %}
      {{ _("Digitization Resources") }}
    {% else %}
      {{ h.nav_link(_(dataset_type.title() + 's'), named_route='%s.search' % dataset_type) }}
    {% endif %}
  </li>
{% endblock %}

{% block page_primary_action %}
{% if h.check_access('package_create') %}
<div class="page_primary_action d-flex align-items-center flex-wrap gap-2">
  
  {# Add Resource dropdown #}
  <div class="dropdown">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      {{ _('Add Resource') }}
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{{ h.url_for('book.new') }}">{{ _('Book') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('digital-document.new') }}">{{ _('Digital Document') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('event.new') }}">{{ _('Event') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('learning-resource.new') }}">{{ _('Learning Resource') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('scholarly-article.new') }}">{{ _('Scholarly Article') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('software-application.new') }}">{{ _('Software Application') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('software-source-code.new') }}">{{ _('Software Source Code') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('video-object.new') }}">{{ _('Video Object') }}</a></li>
      <li><a class="dropdown-item" href="{{ h.url_for('web-content.new') }}">{{ _('Web Content') }}</a></li>
    </ul>
  </div>

  {# NEW: Group Add Toolbar - only for authenticated users #}
  {% if current_user.is_authenticated %}
    {% snippet 'digitizationknowledge/snippets/group_add_toolbar.html' %}
  {% endif %}

</div>
{% endif %}
{% endblock %}


{% block form %}
{% set facets = {
  'fields': fields_grouped,
  'search': search_facets,
  'titles': facet_titles,
  'translated_fields': translated_fields,
  'remove_field': remove_field }
%}
{% set sorting = [
  (_('Relevance'), 'score desc, metadata_modified desc'),
  (_('Name Ascending'), 'title_string asc'),
  (_('Name Descending'), 'title_string desc'),
  (_('Last Modified'), 'metadata_modified desc')
  ]
%}
{% snippet 'snippets/search_form.html', form_id='dataset-search-form', type=dataset_type, query=q, sorting=sorting, sorting_selected=sort_by_selected, count=page.item_count, placeholder=h.humanize_entity_type('package', dataset_type, 'search placeholder') or _('Search resources...'), facets=facets, show_empty=request.args, error=query_error, fields=fields %}
{% endblock %}


{% block package_search_results_list %}
  {# Override to use our custom package list with group add buttons #}
  {% snippet 'digitizationknowledge/snippets/package_list_group_add.html', packages=page.items %}
{% endblock %}


{% block secondary_content %}

{% set basic_facets = ['task_clusters', 'task', 'preparations', 'tags', 'digitization_academy_course', 'discipline', 'audience', 'in_language', ] %}
{% set all_facet_keys = facet_titles.keys() | list %}
{% set advanced_facets = all_facet_keys | reject('in', basic_facets) | list %}

  <div class="filters" x-data="{showAdvanced:false}" x-cloak>
    <div>
      <!-- Basic facets - always shown -->
      {% for facet in basic_facets %}
        {% if facet in facet_titles %}
          {% snippet 'snippets/facet_list.html', title=facet_titles[facet], name=facet, search_facets=search_facets %}
        {% endif %}
      {% endfor %}

          <!-- Advanced facets - conditionally shown -->
    {% if advanced_facets %}
      <div x-show="showAdvanced" 
           x-cloak
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="opacity-0 transform -translate-y-2"
           x-transition:enter-end="opacity-100 transform translate-y-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="opacity-100 transform translate-y-0"
           x-transition:leave-end="opacity-0 transform -translate-y-2">
        {% for facet in advanced_facets %}
          {% snippet 'snippets/facet_list.html', title=facet_titles[facet], name=facet, search_facets=search_facets %}
        {% endfor %}
      </div>
      
      <!-- Toggle button -->
      <div class="mt-3 d-flex justify-content-center" x-cloak>
        <button type="button" 
                @click="showAdvanced = !showAdvanced"
                class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-chevron-down"
             :class="{ 'fa-chevron-down': !showAdvanced, 'fa-chevron-up': showAdvanced }"></i>
          <span x-show="!showAdvanced">{{ _('Show More Filters') }}</span>
          <span x-show="showAdvanced" style="display: none;">{{ _('Show Fewer Filters') }}</span>
        </button>
      </div>
    {% endif %}
    </div>
    <a class="close no-text hide-filters"><i class="fa fa-times-circle"></i><span class="text">close</span></a>
  </div>

<style>
 [x-cloak] { 
  display: none !important; 
 }
</style>
{% endblock %}