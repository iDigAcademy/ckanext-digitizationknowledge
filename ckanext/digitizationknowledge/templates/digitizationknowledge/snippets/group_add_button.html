{#
Group Add Button - Shows add/status button for a single dataset.
#}

{% set dataset_id = dataset_id or '' %}

<div class="group-add-button"
     x-data="groupAddButton('{{ dataset_id }}')"
     x-init="init()">
  
  <template x-if="enabled">
    <div x-ref="statusContainer">
      {# No group selected yet #}
      <template x-if="!groupId">
        <span class="badge bg-secondary">
          <i class="fa fa-folder"></i> --
        </span>
      </template>
      
      {# Loading #}
      <template x-if="groupId && status === 'loading'">
        <span class="badge bg-light text-muted">
          <i class="fa fa-spinner fa-spin"></i>
        </span>
      </template>
      
      {# Already in group #}
      <template x-if="groupId && status === 'in-group'">
        <span class="badge bg-success">
          <i class="fa fa-check"></i> In group
        </span>
      </template>
      
      {# Not in group - show add button #}
      <template x-if="groupId && status === 'not-in-group'">
        <button type="button" 
                class="btn btn-sm btn-outline-primary"
                @click="addToGroup()"
                :disabled="adding">
          <span x-show="!adding"><i class="fa fa-plus"></i> Add</span>
          <span x-show="adding"><i class="fa fa-spinner fa-spin"></i></span>
        </button>
      </template>
      
      {# Error state #}
      <template x-if="groupId && status === 'error'">
        <span class="badge bg-warning">Error</span>
      </template>
    </div>
  </template>
</div>

<script>
function groupAddButton(datasetId) {
  return {
    datasetId: datasetId,
    enabled: false,
    groupId: '',
    status: 'idle',  // idle, loading, in-group, not-in-group, error
    adding: false,

    init() {
      // Listen for state changes from toolbar
      window.addEventListener('groupAddStateChanged', (e) => {
        this.enabled = e.detail.enabled;
        const newGroupId = e.detail.selectedGroupId;
        
        // Only fetch if group changed
        if (newGroupId !== this.groupId) {
          this.groupId = newGroupId;
          this.checkStatus();
        }
      });
      
      // Restore initial state from sessionStorage
      const saved = sessionStorage.getItem('groupAddState');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          this.enabled = state.enabled || false;
          this.groupId = state.selectedGroupId || '';
          if (this.enabled && this.groupId) {
            this.checkStatus();
          }
        } catch (e) {
          console.error('Failed to restore state:', e);
        }
      }
    },

    async checkStatus() {
      if (!this.groupId || !this.datasetId) {
        this.status = 'idle';
        return;
      }
      
      this.status = 'loading';
      
      try {
        const response = await fetch(`/group-add/status/${this.groupId}/${this.datasetId}`);
        const text = await response.text();
        
        // Parse the response to determine status
        if (text.includes('In group') || text.includes('fa-check')) {
          this.status = 'in-group';
        } else if (text.includes('Add') || text.includes('fa-plus')) {
          this.status = 'not-in-group';
        } else {
          this.status = 'error';
        }
      } catch (e) {
        console.error('Status check failed:', e);
        this.status = 'error';
      }
    },

    async addToGroup() {
      if (!this.groupId || !this.datasetId || this.adding) return;
      
      this.adding = true;
      
      try {
        const formData = new FormData();
        formData.append('dataset_id', this.datasetId);
        formData.append('group_id', this.groupId);
        
        const response = await fetch('/group-add/add', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          this.status = 'in-group';
        } else {
          this.status = 'error';
        }
      } catch (e) {
        console.error('Add to group failed:', e);
        this.status = 'error';
      } finally {
        this.adding = false;
      }
    }
  };
}
</script>